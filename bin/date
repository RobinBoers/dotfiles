#!/usr/bin/env bash
# Portable version of `date` because GNU and BSD versions are wildly incompatible.

for BIN in /bin/date /usr/bin/date /usr/local/bin/date; do
    if [ -x "$BIN" ]; then
        break
    fi
done

if quiet "$BIN" --version; then
    IS_GNU=true
else
    IS_GNU=false
fi

if $IS_GNU; then
    INFORMAT=""
    INDATE=""
    OUTFMT=""
    OTHER_ARGS=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -j)
                # ignore on GNU
                shift
                ;;
            -f)
                INFORMAT="$2"
                shift 2
                ;;
            +*)
                OUTFMT="$1"
                shift
                ;;
            *)
                if [[ -n "$INFORMAT" && -z "$INDATE" ]]; then
                    INDATE="$1"
                else
                    OTHER_ARGS+=("$1")
                fi
                shift
                ;;
        esac
    done

    # If BSD-style formatting was used, convert it
    if [[ -n "$INFORMAT" && -n "$INDATE" ]]; then
        exec "$BIN" -d "$INDATE" $OUTFMT "${OTHER_ARGS[@]}"
    else
        # Otherwise behave like real date
        exec "$BIN" "$@"
    fi
fi

# On MacOS or BSD, pass trough directly
exec "$BIN" "$@"
