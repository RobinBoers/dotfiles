#!/bin/sh -eu

command -v curl >/dev/null 2>&1 || { 
    echo >&2 "Error: curl is required but not installed. Aborting."
    echo >&2 
    exit 1
}


if [ $# -ne 1 ]; then
    echo >&2 "Usage: $0 <URL>"
    echo >&2
    exit 1
fi

cache_directory="${XDG_CACHE_HOME:-"$HOME/.cache"}/netcat"
cache_path="$cache_directory/$(echo "$1" | md5sum | awk '{print $1}')"

if [ -e "$cache_path" -a -z "${REFETCH:-}" ]; then
    last_mod=$(date -r "$cache_path" +%s)
    now=$(date +%s)
    diff=$((now - last_mod))

    # 30 days in seconds
    if [ "$diff" -gt 2592000 ]; then
        curl "$1" -o "$cache_path" -z "$cache_path" > /dev/null 2>&1 
    fi
else
    mkdir -p "$cache_directory"
    curl "$1" -o "$cache_path" > /dev/null 2>&1 
fi

[ -e "$cache_path" ] && cat "$cache_path" || {
    echo >&2 "Error: downloading file failed and local copy doesn't exist."
    echo >&2 
    exit 1
}

